<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CanlÄ± YayÄ±n (Stabilize EdilmiÅŸ)</title>

<style>
    body { margin:0; background:black; overflow:hidden; }
    #videoContainer { width:100vw; height:100vh; position:relative; background:black; }
    video { width:100%; height:100%; object-fit:contain; background:black; }

    #controls {
        position:absolute; bottom:0; left:0;
        width:100%; height:55px;
        background:rgba(0,0,0,0.55);
        display:flex; align-items:center;
        padding:0 12px;
        opacity:0; transition:opacity .3s;
        box-sizing: border-box;
    }

    #liveTag {
        color:white; font-size:15px; display:flex; align-items:center;
        margin-right:10px; flex-shrink:0;
    }
    #liveTag::before {
        content:""; width:10px; height:10px; background:red;
        border-radius:50%; margin-right:6px; display:inline-block;
    }

    #progress { flex:1; margin:0 12px; min-width:0; }
    #progress input { width:100%; display:block; }

    #volumeBtn, #fsBtn {
        font-size:28px; color:white; margin-left:10px;
        cursor:pointer; flex-shrink:0;
    }
</style>
</head>

<body>

<div id="videoContainer">
    <video id="player" autoplay playsinline></video>

    <div id="controls">
        <div id="liveTag">LIVE</div>

        <div id="progress">
            <input type="range" id="seek" min="0" max="100" value="0" style="display:none;">
        </div>

        <div id="volumeBtn">ðŸ”Š</div>
        <div id="fsBtn">â›¶</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
const kontrolURL = "https://raw.githubusercontent.com/Utay88/Utay88/main/kontrol.json";
const LIVE_CHECK_INTERVAL = 5000; // YayÄ±n kontrol aralÄ±ÄŸÄ± (5 saniye)
const RECONNECT_DELAY = 5000;     // Hata sonrasÄ± yeniden baÄŸlanma gecikmesi (5 saniye)

let video = document.getElementById("player");
let controls = document.getElementById("controls");
let seek = document.getElementById("seek");
let hideTimer;
let hls;
let currentStream = "";
let reconnectTimeout;

/* -------------------------
   ALT BAR OTOMATÄ°K GÄ°ZLENME
--------------------------*/
function showControls() {
    controls.style.opacity = 1;
    clearTimeout(hideTimer);
    hideTimer = setTimeout(() => {
        controls.style.opacity = 0;
    }, 3000);
}
document.body.addEventListener("mousemove", showControls);
document.body.addEventListener("click", showControls);

/* -------------------------
   HATA Ä°ÅžLEME VE YENÄ°DEN BAÄžLANMA
--------------------------*/
function handleHlsError(event, data) {
    if (data.fatal) {
        console.error("HLS Fatal Error:", data);
        if (hls) hls.destroy();
        
        // Yeniden baÄŸlanmayÄ± gecikmeli olarak dene
        if (reconnectTimeout) clearTimeout(reconnectTimeout);
        reconnectTimeout = setTimeout(() => {
            console.log("Hata sonrasÄ± yayÄ±nÄ± yeniden yÃ¼kleme denemesi...");
            loadStream(currentStream); // Mevcut yayÄ±nÄ± yeniden yÃ¼kle
        }, RECONNECT_DELAY);
    }
}

/* -------------------------
   YAYINI YÃœKLE
--------------------------*/
function loadStream(url) {
    if (hls) {
        hls.stopLoad();
        hls.destroy();
    }
    video.src = "";

    if (!url) {
        console.log("YayÄ±n URL'si boÅŸ.");
        return;
    }
    
    // BaÄŸlantÄ± gecikmesini temizle
    if (reconnectTimeout) clearTimeout(reconnectTimeout);


    if (Hls.isSupported()) {
        hls = new Hls({
            // Stabilite iÃ§in ayarlar
            maxBufferLength: 30,  // Maksimum tampon uzunluÄŸu (saniye)
            maxMaxBufferLength: 60, // Ä°stenen maksimum tampon uzunluÄŸu
            liveSyncDurationCount: 3, // CanlÄ± yayÄ±n senkronizasyonu iÃ§in gereken segment sayÄ±sÄ±
            liveMaxLatencyDurationCount: Infinity, // CanlÄ± gecikme kÄ±sÄ±tlamasÄ±nÄ± kaldÄ±r
        });

        hls.loadSource(url);
        hls.attachMedia(video);

        /* EN YÃœKSEK KALÄ°TEYE SABÄ°TLEME */
        hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
            if (data.levels && data.levels.length > 0) {
                let highest = data.levels.length - 1;
                hls.currentLevel = highest;   // kaliteyi kilitle
            }
            video.play().catch(e => console.log("Video oynatma hatasÄ±:", e));
        });

        /* EÄŸer kalite deÄŸiÅŸmeye Ã§alÄ±ÅŸÄ±rsa tekrar en yÃ¼kseÄŸe Ã§ek */
        hls.on(Hls.Events.LEVEL_SWITCHING, function () {
            hls.nextLevel = hls.levels.length - 1;
        });

        // Hata yakalama
        hls.on(Hls.Events.ERROR, handleHlsError);

    } else {
        video.src = url;
        video.play().catch(e => console.log("Video oynatma hatasÄ±:", e));
    }
}

/* -------------------------
   JSON TAKÄ°P
--------------------------*/
function checkStream() {
    fetch(kontrolURL + "?t=" + Date.now())
        .then(r => {
            if (!r.ok) throw new Error("JSON yÃ¼klenemedi.");
            return r.json();
        })
        .then(d => {
            // Sadece URL deÄŸiÅŸirse yayÄ±nÄ± yeniden yÃ¼kle
            if (d.yayin && d.yayin !== currentStream) {
                console.log("Yeni yayÄ±n bulundu: ", d.yayin);
                currentStream = d.yayin;
                loadStream(currentStream);
            }
        })
        .catch(e => console.error("YayÄ±n kontrol hatasÄ±:", e));
}
setInterval(checkStream, LIVE_CHECK_INTERVAL);
checkStream(); // Sayfa yÃ¼klendiÄŸinde hemen baÅŸlat

/* -------------------------
   SEEK BAR (CanlÄ± yayÄ±n iÃ§in pasif bÄ±rakÄ±ldÄ±)
--------------------------*/
// CanlÄ± yayÄ±nlarda seek bar genellikle kullanÄ±lmaz ve kaldÄ±rÄ±lmÄ±ÅŸtÄ±r.
// EÄŸer bu kodlarÄ± tutmak isterseniz:
/*
video.addEventListener("timeupdate", () => {
    if (!video.duration || isNaN(video.duration)) return;
    seek.value = (video.currentTime / video.duration) * 100;
});
seek.addEventListener("input", () => {
    if (!video.duration || isNaN(video.duration)) return;
    video.currentTime = (seek.value / 100) * video.duration;
});
*/

/* -------------------------
   SES
--------------------------*/
document.getElementById("volumeBtn").onclick = () => {
    video.muted = !video.muted;
    document.getElementById("volumeBtn").textContent = video.muted ? 'ðŸ”‡' : 'ðŸ”Š';
};

/* -------------------------
   TAM EKRAN
--------------------------*/
document.getElementById("fsBtn").onclick = () => {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        document.getElementById("fsBtn").textContent = 'ç¸®'; // KÃ¼Ã§Ã¼ltme ikonu
    } else {
        document.exitFullscreen();
        document.getElementById("fsBtn").textContent = 'â›¶'; // BÃ¼yÃ¼tme ikonu
    }
};
</script>

</body>
</html>
